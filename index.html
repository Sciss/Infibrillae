<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>in|fibrillae</title>
    <link href="assets/lucre-swing.css" rel="stylesheet">
    <script type="text/javascript" src="lib/main.js"></script>
</head>
<style>
      .emscripten { padding-right: 0; margin-left: auto; margin-right: auto; display: block; }
      div.emscripten { text-align: center; }
      div.emscripten_border { border: 1px solid black; }

      body {
        margin: 10%;
        font-size: 13px;
      }

      h1 {
        font-family: 'Voltaire';
        font-size: 24px;
      }

      h2 {
        font-family: 'Voltaire';
        font-size: 18px;
      }

      p {
        font-size: 13px;
      }

      a.infib-ext:before {
        content: "â›¶\0000a0";
      }

      #status {
        display: inline-block;
        vertical-align: top;
        margin-top: 30px;
        margin-left: 20px;
        font-weight: bold;
        color: rgb(120, 120, 120);
      }

      @font-face {
        font-family: 'Voltaire';
        src: url('assets/Voltaire-Regular.ttf');
      }

      #canvas {
        outline: none;  // cf. https://stackoverflow.com/questions/3015523/remove-or-disable-focus-border-of-browser-via-javascript
      }

      #piece {
        margin-top: 1em;
        margin-bottom: 48px;
        min-height: 40px;
      }

      #visual {
        max-width: 400px;
        cursor: crosshair;
      }

      #header {
        max-width: 640px;
        margin-left: auto;
        margin-right: auto;
      }

      #descr {
        display: none;
      }

      .center-screen {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
}
    </style>
<body>
<div id="header" >
<h1>in|fibrillae</h1>
<h2>A sound piece for the web browser</h2>
<p>Hanns Holger Rutz &amp; Nayar&iacute; Castillo, 2021. <input type='button' id='show-descr' value='details'></p>
    <div id="descr">
<p>
    For more information, please
    see <a class="infib-ext" href="https://www.researchcatalogue.net/view/711664/1111185" target="_blank">project documentation</a>.
    Minimum browser requirement: Firefox&nbsp;79, Chrome/Chromium&nbsp;68. Firefox 88 or newer recommended. Mobile phones currently not supported.
</p><p>
    Press the <em>Start</em> button to begin. It may take some time until you hear the first bleeps and noises.
    If the microphone is enabled (default), be aware that feedback sounds may occur.
    Please feel invited to keep the page open while turning to other activities on your
    computer. While the work is marked as in-progress, if you revisit this page, please purge the cache and
    explicitly reload (<kbd>ctrl</kbd>-<kbd>R</kbd>) the page in the browser, as there might be updates. Thank you!
</p><p>
    Also note that sound may be choppy sometimes, it seems the current web audio implementation comes to its limits.
    This happens for example on Chromium&nbsp;90 Linux.
    We are planning to address this, and also to release a desktop downloadable version of the piece.
</p><p>
    The piece released under Creative Commons Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)
    license. The underlying software released under AGPL and GPL licenses. The font is Voltaire-Regular by
    Yvonne Sch&uuml;ttler, released under Open Font License.
    Please refer to the
    <a class="infib-ext" href="https://github.com/Sciss/Infibrillae" target="_blank">source repository</a>.
</p>
    </div>
</div>
<!-- cf. https://stackoverflow.com/questions/12886286/addeventlistener-for-keydown-on-canvas -->
<div class="center-screen">
    <div id="piece"><p>Loading...</p></div>
    <div id="visual"><canvas id="canvas" width="400" height="400" tabindex='1'></canvas></div>
</div>
<span class="emscripten" id="status"></span>

<script type='text/javascript'>
  var statusElement   = document.getElementById('status');
  var hasCrashed      = false;

  var Module = {
    preRun: [],
    postRun: [],
    print: (function() {
      return function(text) {
        if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
        console.log(text);
        if (!hasCrashed && text.startsWith("*** ERROR: SynthDef ")) {
          hasCrashed = true;
          alert("Sorry!\nIt seems SuperCollider has crashed.\nPlease reload the page and start over.");
        }
      };
    })(),
    printErr: function(text) {
      if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
      console.error(text);
    },
    setStatus: function(text) {
      if (!Module.setStatus.last) Module.setStatus.last = { time: Date.now(), text: '' };
      if (text === Module.setStatus.last.text) return;
      var m = text.match(/([^(]+)\((\d+(\.\d+)?)\/(\d+)\)/);
      var now = Date.now();
      if (m && now - Module.setStatus.last.time < 30) return; // if this is a progress update, skip it if too soon
      Module.setStatus.last.time = now;
      Module.setStatus.last.text = text;
      if (m) {
        text = m[1];
      }
      statusElement.innerHTML = text;
    },
    totalDependencies: 0,
    monitorRunDependencies: function(left) {
      this.totalDependencies = Math.max(this.totalDependencies, left);
      Module.setStatus(left ? 'Preparing... (' + (this.totalDependencies-left) + '/' + this.totalDependencies + ')' : 'All downloads complete.');
    },
    onRuntimeInitialized: function() {
    }
  };
  Module.setStatus('Downloading scsynth...');
  window.onerror = function(event) {
    // TODO: do not warn on ok events like simulating an infinite loop or exitStatus
    Module.setStatus('Exception thrown, see JavaScript console');
    Module.setStatus = function(text) {
      if (text) Module.printErr('[post-exception status] ' + text);
    };
  };

  var ggInfo = document.getElementById('show-descr'); // Assumes element with id='button'

  ggInfo.onclick = function() {
    var div = document.getElementById('descr');
    if (div.style.display === 'block') {
      div.style.display = 'none';
      ggInfo.value = 'details';
    } else {
      div.style.display = 'block';
      ggInfo.value = 'hide';
    }
  };

  if (window.SharedArrayBuffer === undefined) {
    alert("This browser does not support Web Assembly fully.\nRecommended browser is Firefox 88 or newer.")
  }
</script>
<script async type="text/javascript" src="lib/scsynth.js"></script>
</body>
</html>
